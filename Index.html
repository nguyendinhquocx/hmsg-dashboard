<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('CSS'); ?>
  </head>
  <body>
    <!-- Header v·ªõi logo, title, tab navigation v√† user profile -->
    <header class="app-header">
      <div class="header-left">
        <img src="https://cdn-icons-png.flaticon.com/128/497/497384.png" alt="Logo" class="app-logo"/>
        <h1 class="app-title">HMSG P.KD</h1>
        <nav class="gallery-nav" id="galleryNav"></nav>
      </div>
      
      <div class="header-right">
        <!-- Th√™m n√∫t KSK ·ªü ƒë√¢y -->
        <a href="https://ksk.hmsg.fun/" target="_blank" class="ksk-link-btn" title="Kh√°m s·ª©c kh·ªèe HMSG">
          KSK
        </a>
        
        <button class="refresh-btn" id="refreshBtn" title="T·∫£i l·∫°i trang" onclick="refreshApp()"></button>
        
        <div class="user-profile-box" id="userProfileBox" style="display:none;">
          <span class="user-name" id="userName"></span>
          <button class="user-avatar-btn" id="userAvatarBtn" aria-haspopup="true" aria-expanded="false">
            <img class="user-avatar-img" id="userAvatarImg" src="" alt="·∫¢nh ƒë·∫°i di·ªán"/>
          </button>
          <div class="dropdown-menu" id="profileDropdown" role="menu">
            <button class="dropdown-action-btn" onclick="openModal('modalChangePass'); closeDropdown();">
              ƒê·ªïi m·∫≠t kh·∫©u
            </button>
            <button class="dropdown-action-btn" onclick="openModal('modalChangeAvatar'); closeDropdown();">
              C·∫≠p nh·∫≠t avatar
            </button>
            <button class="dropdown-action-btn logout" onclick="logoutUser()">
              ƒêƒÉng xu·∫•t
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Ph·∫ßn c√≤n l·∫°i gi·ªØ nguy√™n -->
    <main class="main-content" id="mainContent">
      <div class="dashboard-card">
        <div id="gallery" class="gallery"></div>
      </div>
    </main>

    <button id="exportPDF" class="export-btn" style="display:none;" title="Xu·∫•t PDF"></button>

    <!-- C√°c modal gi·ªØ nguy√™n -->
    <div class="center-modal-bg" id="modalChangePass">
      <div class="center-modal-box">
        <button class="center-modal-close" onclick="closeModal('modalChangePass')">&times;</button>
        <div class="center-modal-title">ƒê·ªïi m·∫≠t kh·∫©u</div>
        <form class="modal-form-row" id="changePasswordForm" autocomplete="off">
          <input class="modal-input" id="oldPassword" type="password" placeholder="M·∫≠t kh·∫©u c≈©" required>
          <input class="modal-input" id="newPassword" type="password" placeholder="M·∫≠t kh·∫©u m·ªõi" required>
          <button class="modal-submit-btn" type="submit">C·∫≠p nh·∫≠t</button>
          <div class="modal-error" id="changePasswordError"></div>
          <div class="modal-success" id="changePasswordSuccess"></div>
        </form>
      </div>
    </div>

    <div class="center-modal-bg" id="modalChangeAvatar">
      <div class="center-modal-box">
        <button class="center-modal-close" onclick="closeModal('modalChangeAvatar')">&times;</button>
        <div class="center-modal-title">C·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán</div>
        <form class="modal-form-row" id="changeAvatarForm" autocomplete="off">
          <input class="modal-input" id="newAvatarUrl" type="url" placeholder="D√°n URL h√¨nh ·∫£nh" required>
          <button class="modal-submit-btn" type="submit">C·∫≠p nh·∫≠t</button>
          <div class="modal-error" id="changeAvatarError"></div>
          <div class="modal-success" id="changeAvatarSuccess"></div>
        </form>
      </div>
    </div>

    <div class="modal" id="modal" onclick="hideModal(event)">
      <img class="modal-img" id="modalImg"/>
      <button id="prevBtn" class="arrow-btn left" onclick="prevImg(event)">‚Äπ</button>
      <button id="nextBtn" class="arrow-btn right" onclick="nextImg(event)">‚Ä∫</button>
    </div>

    <?!= include('JavaScript'); ?>

    <script>
      // Refresh app function
      function refreshApp() {
        galleryCache = {}; // Clear cache
        currentGallery = null;
        images = [];
        currentIdx = 0;
        
        // Show loading state
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = `
          <div style="
            text-align: center;
            color: var(--gray-medium);
            padding: 40px 20px;
            font-size: 14px;
          ">
            <div style="margin-bottom: 12px;">üîÑ</div>
            ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...
          </div>
        `;
        
        // Reinitialize everything
        initGallery();
      }

      // User profile v√† authentication
      function logoutUser() {
        google.script.run.withSuccessHandler(function(res){
          document.open();
          document.write(res.html);
          document.close();
        }).logout();
      }

      function closeDropdown() {
        document.getElementById('profileDropdown').classList.remove('open');
        document.getElementById('userAvatarBtn').setAttribute('aria-expanded','false');
      }

      function showUserProfile() {
        google.script.run.withSuccessHandler(function(user){
          if(!user) return;
          document.getElementById('userProfileBox').style.display = 'flex';
          document.getElementById('userName').textContent = user['ten nhan vien'] || '';
          document.getElementById('userAvatarImg').src = user['hinh anh'] || 'https://via.placeholder.com/32';
        }).getCurrentUser();
      }

      function setupProfileDropdown() {
        const avatarBtn = document.getElementById('userAvatarBtn');
        const dropdown = document.getElementById('profileDropdown');
        
        avatarBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          dropdown.classList.toggle('open');
          avatarBtn.setAttribute('aria-expanded', dropdown.classList.contains('open') ? 'true' : 'false');
        });
        
        document.addEventListener('click', function(e){
          if (!dropdown.contains(e.target) && !avatarBtn.contains(e.target)) {
            closeDropdown();
          }
        });
      }

      // Modal management
      function openModal(id) {
        document.getElementById(id).classList.add('open');
      }

      function closeModal(id) {
        document.getElementById(id).classList.remove('open');
      }

      // ƒê·ªïi m·∫≠t kh·∫©u
      function setupChangePassword() {
        const form = document.getElementById('changePasswordForm');
        const errorDiv = document.getElementById('changePasswordError');
        const successDiv = document.getElementById('changePasswordSuccess');
        
        form.onsubmit = function(e) {
          e.preventDefault();
          errorDiv.textContent = "";
          successDiv.textContent = "";
          
          const oldPassword = document.getElementById('oldPassword').value.trim();
          const newPassword = document.getElementById('newPassword').value.trim();
          
          if (newPassword.length < 4) {
            errorDiv.textContent = "M·∫≠t kh·∫©u m·ªõi t·ªëi thi·ªÉu 4 k√Ω t·ª±!";
            return;
          }
          
          google.script.run.withSuccessHandler(function(res){
            if(res.success){
              successDiv.textContent = "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!";
              errorDiv.textContent = "";
              form.reset();
            } else {
              errorDiv.textContent = res.message || "ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i!";
              successDiv.textContent = "";
            }
          }).changePassword(oldPassword, newPassword);
        };
      }

      // ƒê·ªïi avatar
      function setupChangeAvatar() {
        const form = document.getElementById('changeAvatarForm');
        const errorDiv = document.getElementById('changeAvatarError');
        const successDiv = document.getElementById('changeAvatarSuccess');
        
        form.onsubmit = function(e) {
          e.preventDefault();
          errorDiv.textContent = "";
          successDiv.textContent = "";
          
          const url = document.getElementById('newAvatarUrl').value.trim();
          if(!/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)$/i.test(url)) {
            errorDiv.textContent = "URL kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ph·∫£i ·∫£nh!";
            return;
          }
          
          const img = new Image();
          img.onload = function() {
            google.script.run.withSuccessHandler(function(res){
              if(res.success){
                successDiv.textContent = "C·∫≠p nh·∫≠t ·∫£nh th√†nh c√¥ng!";
                errorDiv.textContent = "";
                document.getElementById('userAvatarImg').src = url;
                form.reset();
              } else {
                errorDiv.textContent = res.message || "C·∫≠p nh·∫≠t h√¨nh ·∫£nh th·∫•t b·∫°i!";
                successDiv.textContent = "";
              }
            }).changeAvatar(url);
          };
          img.onerror = function() {
            errorDiv.textContent = "URL kh√¥ng h·ª£p l·ªá ho·∫∑c ·∫£nh kh√¥ng t·ªìn t·∫°i!";
          };
          img.src = url;
        };
      }

      // Keyboard shortcuts v√† events
      document.addEventListener('keydown', function(e){
        if(e.key === "Escape"){
          document.querySelectorAll('.center-modal-bg.open').forEach(modal => modal.classList.remove('open'));
        }
      });

      // Initialize everything
      window.addEventListener('DOMContentLoaded', function() {
        showUserProfile();
        setupProfileDropdown();
        setupChangePassword();
        setupChangeAvatar();
      });
    </script>
  </body>
</html>